<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pré-sala | Psii + LiveKit</title>

  <!-- CSS dos Components (UNPKG) -->
  <link rel="stylesheet"
        href="https://unpkg.com/@livekit/components@2.5.6/dist/style.css" />

  <style>
    :root { color-scheme: dark; }
    html,body { height:100%; margin:0; background:#0f1115; color:#eaecef; font-family:Inter,system-ui,Arial }
    .wrap { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:12px }
    livekit-room, livekit-video-conference { width:100%; height:100% }
    #msg { position:fixed; left:0; right:0; top:0; padding:10px 16px; background:#151922; border-bottom:1px solid #2a2f3a; display:none; white-space:pre-wrap }
  </style>
</head>
<body>
  <div id="msg">Carregando…</div>

  <div class="wrap">
    <livekit-room id="room" style="width:100%; height:100%;">
      <!-- PRÉ-JOIN (preview) -->
      <livekit-prejoin slot="prejoin"
        style="--lk-control-bar-bg:#151922; --lk-bg:#0f1115; --lk-button-primary-bg:#00B37E; --lk-button-primary-text:#fff">
      </livekit-prejoin>

      <!-- Conferência após confirmar -->
      <livekit-video-conference></livekit-video-conference>
    </livekit-room>
  </div>

  <script type="module">
    const show = (t) => { const m=document.getElementById('msg'); m.textContent=t; m.style.display=t?'block':'none'; console.log(t); };

    async function loadComponents() {
      const sources = [
        'https://unpkg.com/@livekit/components@2.5.6/dist/livekit-elements.js',
        'https://cdn.jsdelivr.net/npm/@livekit/components@2.5.6/dist/livekit-elements.js',
        'https://esm.sh/@livekit/components@2.5.6/dist/livekit-elements.js'
      ];
      let lastErr;
      for (const src of sources) {
        try { show('Carregando Components de: ' + src); await import(src); return; }
        catch (e) { lastErr = e; }
      }
      throw lastErr || new Error('Falha ao importar Components');
    }

    (async () => {
      try {
        await loadComponents();
      } catch(e) {
        show('Falha ao carregar LiveKit Components.\n' + (e?.message || e));
        return;
      }

      try {
        const p = new URLSearchParams(location.search);
        const token = p.get('token') || '';
        const ws    = p.get('ws') || p.get('serverUrl') || '';
        if (!token || !ws) {
          show('Token ou serverUrl ausentes.\nUse ?token=...&ws=wss://seu-projeto.livekit.cloud');
          return;
        }

        await customElements.whenDefined('livekit-room');
        const room = document.getElementById('room');
        room.connect = false;     // mantém pré-join
        room.serverUrl = ws;
        room.token = token;

        show('');
      } catch (e) {
        show('Erro durante init:\n' + (e?.message || e));
      }
    })();
  </script>
</body>
</html>
